define(["jquery","backbone","utils","hbs!../../templates/ical_upload"],function(e,t,n,i){function s(e,t){var i=new XMLHttpRequest;i.upload.addEventListener("loadstart",a,!1),i.upload.addEventListener("progress",o,!1),i.addEventListener("readystatechange",r,!1),i.open("POST",t,!0),i.setRequestHeader("x-csrftoken",n.getCookie("csrftoken")),i.send(e)}function a(){e("#upload-status").html("Upload started!")}function o(t){var n=100*(t.loaded/t.total);e("#progress").html("Progress: "+n+"%")}function r(t){var n=null;try{n=t.target.status}catch(i){return}if(4===t.currentTarget.readyState)if("200"==n&&t.target.responseText){var s=JSON.parse(t.target.responseText);s.length>0?(app.eventList.add(s),1===s.length?app.navigate("event/"+s[0].slug+"/edit",{trigger:!0}):(app.recentEvents=s,app.navigate("added",{trigger:!0}))):alert("no events added!")}else e("#upload_event_error").displayError(t.target.responseText)}var l=t.View.extend({tagName:"div",className:"replace span7 overflow setheight",id:"event_view",initialize:function(){var e=this;app.session.on("change",function(){e.render()})},events:{"click #upload_event":"upload_event","click #import_url":"import_url"},onDOMadd:function(){n.supportAjaxUploadWithProgress()&&(this.useAjax=!0)},render:function(){return this.$el.html(i()),this},upload_event:function(e){if(this.useAjax){e.preventDefault();for(var t=new FormData,n="/upload",i=document.getElementById("file-id"),a=i.files,o=0;a.length>o;o++)t.append("file"+o,a[o]);s(t,n)}},import_url:function(e){if(this.useAjax){e.preventDefault();var t=document.getElementById("form-import"),n=new FormData(t),i="/import";s(n,i)}}});return l});