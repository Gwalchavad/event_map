define(["jquery","backbone","utils","jade!../../templates/ical_upload"],function(e,t,i,n){function s(e,t){var n=new XMLHttpRequest;n.upload.addEventListener("loadstart",r,!1),n.upload.addEventListener("progress",a,!1),n.addEventListener("readystatechange",o,!1),n.open("POST",t,!0),n.setRequestHeader("x-csrftoken",i.getCookie("csrftoken")),n.send(e)}function r(){e("#upload-status").html("Upload started!")}function a(t){var i=100*(t.loaded/t.total);e("#progress").html("Progress: "+i+"%")}function o(t){var i=null;try{i=t.target.status}catch(n){return}if(4===t.currentTarget.readyState)if("200"==i&&t.target.responseText){var s=JSON.parse(t.target.responseText);s.length>0?(app.eventList.add(s),1===s.length?app.navigate("event/"+s[0].slug+"/edit",{trigger:!0}):(app.recentEvents=s,app.navigate("added",{trigger:!0}))):alert("no events added!")}else e("#upload_event_error").displayError(t.target.responseText)}var l=t.View.extend({tagName:"div",className:"replace span7 overflow setheight",id:"event_view",initialize:function(){var e=this;app.session.on("change",function(){e.render()})},events:{"click #upload_event":"upload_event","click #import_url":"import_url"},onDOMadd:function(){i.supportAjaxUploadWithProgress()&&(this.useAjax=!0)},render:function(){return this.$el.html(n()),this},upload_event:function(e){if(this.useAjax){e.preventDefault();for(var t=new FormData,i="/upload",n=document.getElementById("file-id"),r=n.files,a=0;r.length>a;a++)t.append("file"+a,r[a]);s(t,i)}},import_url:function(e){if(this.useAjax){e.preventDefault();var t=document.getElementById("form-import"),i=new FormData(t),n="/import";s(i,n)}}});return l});