define(["jquery","underscore","backbone","leaflet","settings"],function(t,e,n,o,i){o.Icon.Default.imagePath="/static/components/leaflet/dist/images";var r={map:null,currentPos:null,props:{},marker:null,initialize:function(){this.props.center=new o.LatLng(i.center[0],i.center[1]),this.props.bounds=new o.LatLngBounds(i.bounds.ul,i.bounds.lr),this.props.tilesetUrl=i.tilesetUrl,this.props.tilesetAttrib=i.tilesetAttrib;var t=new o.TileLayer(this.props.tilesetUrl,{minZoom:2,maxZoom:20,attribution:this.props.tilesetAttrib});this.map=new o.Map("map",{center:this.props.center,zoom:i.zoom,layers:[t]}),this.group=o.layerGroup(),this.group.addTo(this.map),this.map.on("locationfound",this.onLocationFound,this),this.map.on("locationerror",this.onLocationError,this),this.map.locate({watch:!0,enableHighAccuracy:!0})},onLocationFound:function(t){var e=t.accuracy/2,n=o.marker(t.latlng).addTo(this.map).bindPopup("You are within "+e+" meters from this point");this.props.bounds.contains(t.latlng)&&(this.map.setView(t.latlng,13),n.openPopup()),this.currentPos=t.latlng,o.circle(t.latlng,e).addTo(this.map)},onLocationError:function(t){alert(t.message)},geocode:function(e,n){var i=this;t.ajax({url:"http://www.mapquestapi.com/geocoding/v1/address?key="+this.props.api_key+"&boundingBox="+this.props.bounds.toBBoxString()+"&location="+e,dataType:"jsonp"}).done(function(t){var e=t.results[0].locations[0].latLng;if(this.props.bounds.contains([e.lat,e.lng])){var r=new o.LatLng(e.lat,e.lng);i.map.setView(r,13,!1),this.marker.setLatLng(r),n.onSuccess&&n.onSuccess(e.lat,e.lng)}else n.onFail(t)})},add_marker:function(t,n){var i=t?e.clone(t).reverse():this.props.center;return this.marker=new o.Marker(i,{draggable:n}),this.group.addLayer(this.marker),this.marker}};return o.LatLng.prototype.toUrlString=function(){return this.lat+","+this.lng},r});