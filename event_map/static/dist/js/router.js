define(["jquery","underscore","backbone","models/users","models/events","models/session","views/frame","views/map","views/loading"],function(e,t,i,n,a,s,r,o,l){var d=i.Router.extend({routes:{"":"list","me(/:status)":"me","/:date":"list","event/:id":"eventDetails","event/:id/edit":"eventAdd","add/event":"eventAdd","author/:author(/:status)":"viewAuthor",about:"about","group/:group(/:status)":"viewGroup","add/group":"addGroup","feed/:feed(/:status)":"viewFeed","add/feed":"addFeed",upload:"upload",added:"addedEvents"},loginRequired:["event/:id/edit","me(/:status)","add/event","added"],initialize:function(){var e=RegExp("(/)+$","g");this.route(/(.*)\/+$/,"trailFix",function(t){t=t.replace(e,""),this.navigate(t,!0)}),this.session=new s(init_user),this.appView=new r({model:this.session}),this.appView.render(),this.map=o,this.map.initialize(),this.eventList=new a.EventCollection,this.eventList.reset(init_events)},before:function(e,i){return this.map.group.clearLayers(),t.contains(this.loginRequired,i)&&!this.session.is_authenticated()?(this.appView.login(i),!1):(this.showView(new l),void 0)},list:function(e){this.viewList(e)},viewAuthor:function(e,t){var i={data:{author:e}};i.data.complete=t!==void 0&&"uncomplete"==t?!1:!0,this.viewList(i)},me:function(e){var t={data:{me:!0}};t.data.complete=e!==void 0&&"uncomplete"==e?!1:!0,this.viewList(t)},addedEvents:function(){this.viewList(void 0,!1,this.recentEvents)},viewList:function(e,i,n){var s=this;e===void 0&&(e={}),require(["views/list","views/list_info"],function(r,o){var l,d=!1;e.date&&(d=e.date),n!==void 0?l=new a.EventCollection(n):e.data!==void 0?(l=new a.EventCollection(s.eventList.where(e.data),{data:e.data}),i&&(l._attributes.futureEvents.more=s.eventList._attributes.futureEvents.more,l._attributes.pastEvents.more=s.eventList._attributes.pastEvents.more)):l=!d||d>s.eventList.models[0].get("start_date")&&t.last(s.eventList.models).get("start_date")>d?s.eventList:new a.EventCollection(null,{data:{start:e.date}}),e.model=l;var u=new r.EventsListView(e),h=new o;s.showView([h,u])})},viewGroup:function(){},addGroup:function(e,t){var i=t?t:this;require(["models/groups","views/group_add"],function(e,t){var n=new e,a=new t({model:n});i.showView(a)})},viewFeed:function(){},addFeed:function(e,t){var i=t?t:this;require(["models/feed","views/feed_add"],function(e,t){var n=new e,a=new t({model:n});i.showView(a)})},eventDetails:function(e,t,i){var n=i?i:this,a=t?t:n.eventList.get(e);return a?(require(["views/event"],function(e){var t=new e.EventView({model:a});n.showView(t)}),void 0):(n.fetchEvent(e,this.eventDetails),void 0)},eventAdd:function(e,t,i){var n,s=i?i:this;if(e){if(n=t?t:s.eventList.get(e),!n)return s.fetchEvent(e,s.eventAdd),void 0}else n=new a.Event;require(["views/event_add"],function(e){var t=new e.EventAddView({model:n});s.showView(t)})},about:function(){},upload:function(){var e=this;require(["views/ical_upload"],function(t){var i=new t;e.showView(i)})},showView:function(t){t instanceof Array||(t=[t]),this.currentView&&this.currentView.forEach(function(e){e.close&&e.close()});var i=document.createDocumentFragment();t.forEach(function(e){i.appendChild(e.render().el)}),e("#main").prepend(i),this.currentView=t,t.forEach(function(e){e.onDOMadd&&e.onDOMadd()})},fetchEvent:function(e,t){var i=this,n=new a.Event({slug:e}),s=n.fetch();s.error(function(){throw"event not found"}),s.success(function(){t(e,n,i)})}});return d});